<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>~ ~ ~ ~ T O B I A S ~ ~ ~ ~</title>
    <style>
      body {
        margin:0px;
        padding:50px;
        height:100%;
        background: url(img/stars.gif);
        -webkit-animation:bgscroll 20s infinite linear;
        font-family: sans-serif;
      }

      h2 {
        padding:0px;
        margin:0px 0px 20px 0px;
        font-family: 'SuastOrnad tfb', 'Astro 867', Sans-Serif;
        font-size: 96px;
        font-weight: normal;
      }

      h3 {
        padding:0px;
        margin:0px 0px 20px 0px;
        font-family: 'SuastOrnad tfb', 'Astro 867', Sans-Serif;
        font-size: 20px;
        font-weight: normal;
      }

      #container-element {
        margin:0px;
        color: #fff;
        
        height:100%;
      }

      @-webkit-keyframes bgscroll {
        from {background-position:0 0;}
        to {background-position:0 520px;}
      }   

      @-webkit-keyframes gifscroll {
        0% {right:0px; top:0px;}
        2% {right: 200px; top:0px;}
        100% {right: 200px; top:2000px;}
      }   

      @-webkit-keyframes gifscrolls {
        from {right:0px;}
        to {right: 200px;}
      }   

      #startBtn {
        background-color: #0A68FF;
        padding: 15px 25px 15px 25px;
        border: none;
        border-radius: 6px;
        color: #fff;
        font-size: 20px;
      }

      #stopBtn {
        background-color: #DE3131;
        padding: 15px 25px 15px 25px;
        border: none;
        border-radius: 6px;
        color: #fff;
        font-size: 20px;
      }

      #status {
        position: absolute;
        bottom: 50px;
        line-height: 30px
      }

      .giphy {
        position: absolute;
        right: 0px;
        top: 0px;
        -webkit-animation:gifscroll 20s linear;
        width: 300px;
      }

    </style>
  </head>
  <body>
  <div id="container-element">
    <h2>join us for a story</h2>
   
    <button id="startBtn">Start</button>
    <button id="stopBtn">Stop</button>
    <span id="recording-indicator" style="border-radius: 10px; -moz-border-radius: 10px; -webkit-border-radius: 10px; width: 20px; height: 20px; background: red;"></span>
    <p>What you say?</p>
    <div id="output" style="height:150px;overflow:auto;" >
    </div>
    <div id="status">
      <h3>Status</h3>
      <div id="current-status">Loading page</div>
    </div>


    <script src="js/jquery.js"></script>
    <script src="js/wordlist.js"></script>
    <script>
    var prevWord = '';

    function getGif(lastword) {
      console.log('getgif: '+lastword);
      //var gif = data.data[0].images.fixed_height_still.url;
      var gif = "img/jack.jpg";
      $('#container-element').append("<img class='giphy' src='" + gif + "'/>");
      // img.animate({
      //   'right' : '200px'
      // }, 5000, 'linear', function(el){
      //   el.animate({
      //     'top' : '2000px'
      //   }, 5000, 'linear', function(){});
        
      // });
      // $.getJSON("http://api.giphy.com/v1/gifs/search?q="+lastword+"&api_key=dc6zaTOxFJmzC", function(data) {
      //   var img = $('body').append("<img class='giphy' src='" + gif + "'/>").animate({
                      //   'top' : '2000px'
                      // }, 5000, 'linear', function(){});
     // });
    }

      var keynouns = "Contest,Arguing,Lost,Escaping,Sleeping,Found,Fighting,Love,Journey,Mischief,Alive,Hurt,Meeting,Storm,Imprisoned,Planning,Time,Breaks,Parting,Transforming,Rescued,Revealed,Dying,Food,Axe,Returned,Ring,Clothes,Book,Sword,Door,Cauldron,Trap,Stairs,Fire,Key,Tree,Spell,Crown,Wall,Well,Treasure,Window,Gift,Beautiful,Foolish,Cursed,Brave,Frightened,Poisoned,Disguised,Happy,Fly,Hidden,Lucky,Talk,Healed,Sad,Tiny,Stolen,Ugly,Wicked,Wise,Strong,Faraway,Secret,Blind,lost,City,Crazy,Cave,Dungeon,Cottage,Sky,Garden,Forest,Mountain,Palace,Kitchen,Night,Road,River,Swamp,Tower,Village,Kingdom,Church,Home,Ruin,King,Beggar,Fairy,Prince,Brother,Sister,Giant,Princess,Child,Wolf,Page,Queen,Stepmother,Frog,Guard,Parent,Horse,Cook,Husband,Wife,Monster,Enemy,Old,Dragon,Thief,Orphan,Witch".toUpperCase();

      var keynounsArr = keynouns.split(",");
      console.log(keynounsArr);

      var grammarKeywords = {numStates: 1, start: 0, end: 0, transitions: []};
      for (var i = 0; i < keynounsArr.length; i++) {
        grammarKeywords.transitions.push({from: 0, to: 0, logp: -999990, word: keynounsArr[i]});
      };

      // These will be initialized later
      var recognizer, recorder, callbackManager, audioContext, outputContainer;
      // Only when both recorder and recognizer do we have a ready application
      var recorderReady = recognizerReady = false;

      // A convenience function to post a message to the recognizer and associate
      // a callback to its response
      function postRecognizerJob(message, callback) {
        var msg = message || {};
        if (callbackManager) msg.callbackId = callbackManager.add(callback);
        if (recognizer) recognizer.postMessage(msg);
      };

      // This function initializes an instance of the recorder
      // it posts a message right away and calls onReady when it
      // is ready so that onmessage can be properly set
      function spawnWorker(workerURL, onReady) {
          recognizer = new Worker(workerURL);
          recognizer.onmessage = function(event) {
            onReady(recognizer);
          };
          recognizer.postMessage('');
      };

      // To display the hypothesis sent by the recognizer
      function updateCount(count) {
        console.log("Got count " + count);
        if (outputContainer) outputContainer.innerHTML = count;
      };

      // This updates the UI when the app might get ready
      // Only when both recorder and recognizer are ready do we enable the buttons
      function updateUI() {
        if (recorderReady && recognizerReady) startBtn.disabled = stopBtn.disabled = false;
      };

      // This is just a logging window where we display the status
      function updateStatus(newStatus) {
        document.getElementById('current-status').innerHTML += "<br/>" + newStatus;
      };

      // A not-so-great recording indicator
      function displayRecording(display) {
        if (display) document.getElementById('recording-indicator').innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
        else document.getElementById('recording-indicator').innerHTML = "";
      };

      // Callback function once the user authorises access to the microphone
      // in it, we instanciate the recorder
      function startUserMedia(stream) {
        var input = audioContext.createMediaStreamSource(stream);
        // Firefox hack https://support.mozilla.org/en-US/questions/984179
        window.firefox_audio_hack = input; 
        var audioRecorderConfig = {errorCallback: function(x) {updateStatus("Error from recorder: " + x);}};
        recorder = new AudioRecorder(input, audioRecorderConfig);
        // If a recognizer is ready, we pass it to the recorder
        if (recognizer) recorder.consumers = [recognizer];
        recorderReady = true;
        updateUI();
        updateStatus("Audio recorder ready");
      };

      // This starts recording. We first need to get the id of the keyword search to use
      var startRecording = function() {
        //var id = document.getElementById('keyword').value;
        if (recorder && recorder.start()) displayRecording(true);
      };

      // Stops recording
      var stopRecording = function() {
        recorder && recorder.stop();
        displayRecording(false);
      };

      // Called once the recognizer is ready
      // We then add the grammars to the input select tag and update the UI
      var recognizerReady = function() {
           //updateKeywords();
           recognizerReady = true;
           updateUI();
           updateStatus("Recognizer ready");
      };

      // We get the grammars defined below and fill in the input select tag
      var updateKeywords = function() {
        var selectTag = document.getElementById('keyword');
        for (var i = 0 ; i < keywordIds.length ; i++) {
            var newElt = document.createElement('option');
            newElt.value=keywordIds[i].id;
            newElt.innerHTML = keywordIds[i].title;
            selectTag.appendChild(newElt);
        }                          
      };

      var feedGrammar = function(grammarKeywords, index, id) {
        postRecognizerJob({command: 'addGrammar', data: grammarKeywords});
        recognizerReady();
      };

      // To display the hypothesis sent by the recognizer
      function updateHyp(hyp) {
        if (outputContainer) outputContainer.innerHTML = hyp;
      };

      var feedKeyword = function(g, index, id) {
        if (id && (keynounsArr > 0)) keynounsArr[0] = id.id;
        if (index < g.length) {
          keywordIds.unshift(keynounsArr[0])
    postRecognizerJob({command: 'addKeyword', data: keynounsArr[0]},
                             function(id) {feedKeyword(keynounsArr, index + 1, {id:id});});
        } else {
          recognizerReady();
        }
      };

      // This adds words to the recognizer. When it calls back, we add grammars
      var feedWords = function(words) {
           postRecognizerJob({command: 'addWords', data: words},
                        function() {feedGrammar(grammarKeywords, 0);});
      };

      // This initializes the recognizer. When it calls back, we add words
      var initRecognizer = function() {
          // You can pass parameters to the recognizer, such as : {command: 'initialize', data: [["-hmm", "my_model"], ["-fwdflat", "no"]]}
          postRecognizerJob({command: 'initialize', data: [["-remove_noise", "yes"]]},
                            function() {
                                        if (recorder) recorder.consumers = [recognizer];
                                        feedWords(wordList);});
      };

      // When the page is loaded, we spawn a new recognizer worker and call getUserMedia to
      // request access to the microphone
      window.onload = function() {
        outputContainer = document.getElementById("output");
        updateStatus("Initializing web audio and speech recognizer, waiting for approval to access the microphone");
        callbackManager = new CallbackManager();
        spawnWorker("js/recognizer.js", function(worker) {
            // This is the onmessage function, once the worker is fully loaded
            worker.onmessage = function(e) {
                // This is the case when we have a callback id to be called
                if (e.data.hasOwnProperty('id')) {
                  var clb = callbackManager.get(e.data['id']);
                  var data = {};
                  if ( e.data.hasOwnProperty('data')) data = e.data.data;
                  if(clb) clb(data);
                }
                // This is a case when the recognizer has a new hypothesis
                if (e.data.hasOwnProperty('hyp')) {
                  var newHyp = e.data.hyp;
                  var lastsp = newHyp.split(' ');
                  var lastspLen = lastsp.length;
                  //console.log(lastsp);
                  var lastword = lastsp.pop();
                  if (lastword !== prevWord && lastword !== '') {
                    getGif(lastword);
                  }
                  
                  if (e.data.hasOwnProperty('final') &&  e.data.final) newHyp = "Final: " + newHyp;
                  updateHyp(newHyp);

                  prevWord = lastword;
                }
                // This is the case when we have an error
                if (e.data.hasOwnProperty('status') && (e.data.status == "error")) {
                  updateStatus("Error in " + e.data.command + " with code " + e.data.code);
                }

            };
            // Once the worker is fully loaded, we can call the initialize function
            initRecognizer();
        });

        // The following is to initialize Web Audio
        try {
          window.AudioContext = window.AudioContext || window.webkitAudioContext;
          navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
          window.URL = window.URL || window.webkitURL;
          audioContext = new AudioContext();
        } catch (e) {
          updateStatus("Error initializing Web Audio browser");
        }
        if (navigator.getUserMedia) navigator.getUserMedia({audio: true}, startUserMedia, function(e) {
                                        updateStatus("No live audio input in this browser");
                                    });
        else updateStatus("No web audio support in this browser");

      // Wiring JavaScript to the UI
      var startBtn = document.getElementById('startBtn');
      var stopBtn = document.getElementById('stopBtn');
      startBtn.disabled = true;
      stopBtn.disabled = true;
      startBtn.onclick = startRecording;
      stopBtn.onclick = stopRecording;
      };
      
       // This is the list of words that need to be added to the recognizer
       // This follows the CMU dictionary format
      // var wordList = [["ONE", "W AH N"], ["TWO", "T UW"], ["THREE", "TH R IY"], ["FOUR", "F AO R"], ["FIVE", "F AY V"], ["SIX", "S IH K S"], ["SEVEN", "S EH V AH N"], ["EIGHT", "EY T"], ["NINE", "N AY N"], ["ZERO", "Z IH R OW"], ["NEW-YORK", "N UW Y AO R K"], ["NEW-YORK-CITY", "N UW Y AO R K S IH T IY"], ["PARIS", "P AE R IH S"] , ["PARIS(2)", "P EH R IH S"], ["SHANGHAI", "SH AE NG HH AY"], ["SAN-FRANCISCO", "S AE N F R AE N S IH S K OW"], ["LONDON", "L AH N D AH N"], ["BERLIN", "B ER L IH N"], ["SUCKS", "S AH K S"], ["ROCKS", "R AA K S"], ["IS", "IH Z"], ["NOT", "N AA T"], ["GOOD", "G IH D"], ["GOOD(2)", "G UH D"], ["GREAT", "G R EY T"], ["WINDOWS", "W IH N D OW Z"], ["LINUX", "L IH N AH K S"], ["UNIX", "Y UW N IH K S"], ["MAC", "M AE K"], ["AND", "AE N D"], ["AND(2)", "AH N D"], ["O", "OW"], ["S", "EH S"], ["X", "EH K S"]];

      
      var keywords = [{title: "ONE", g: "ONE"}, {title: "TWO", g: "TWO"}, {title: "NEW-YORK", g: "NEW-YORK"}, {title: "ELEPHANT", g: "ELEPHANT"}];
      var keywordIds = [];
    </script>
    <!-- These are the two JavaScript files you must load in the HTML,
    The recognizer is loaded through a Web Worker -->
    <script src="js/audioRecorder.js"></script>
    <script src="js/callbackManager.js"></script>
    </div>
  </body>
</html>
